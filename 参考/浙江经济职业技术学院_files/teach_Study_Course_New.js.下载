var furl=ServerHost.fanyaurl;
//暂未使用
function fileEffect(){
	$(".Mcon1img").hover(function(){
	$(this).children().eq(1).show();
	$(this).children().eq(2).show();
	},function(){
		$(".Gd").hide();
		$(".move").hide();
	})
}
fileEffect();

function quitDeal(){
	
	$(".Gd").each(function(){
		var delBtn = $(this);
		delBtn.attr("onclick","");
		delBtn.click(function(){
			var course = $(this).parent().parent();
			var cid=course.find("input[name='classId']").val();
			$("#dropTip .tkTitle").html(quitthecourse);
			$("#dropTip .tkCon").html(quitcoursemsg1);
			var h = $(this).offset().top+100;
			
			WAY.box.show({"divid":"dropTip","mask":false,"top":h});
			
				//var mes=confirm("您确定要退出此课程？退课后学习记录将无法恢复！");
				$("#dropTip .confirmBtn").click(function(){
				    $.get("/visit/doarchive/student",
			     		{clazzid:cid},
			            function(data){
			     			WAY.box.hide();
			        		if(data.succ){
			    				 course.stop(true,false).animate({"opacity":"0"},500,function(){
			    					course.remove();
			    				 });
						    }
			  			}
		  			); 
		  	
				});
	  	});
	});
}

//归档事件绑定
function fileDeal(){
	
	$(".Gd").each(function(){
		var delBtn = $(this);
		delBtn.attr("onclick","");
		delBtn.click(function(){
			var course = $(this).parent().parent();
			var cid=course.find("input[name='courseId']").val();
				var mes=confirm("您确定要归档吗？");
			    if(mes==true){
					   jQuery.post("/visit/doarchive/teacher",
				    		{courseid:cid},
				            function(data){
				        		if(data.status){
				    				 course.stop(true,false).animate({"opacity":"0"},500,function(){
				    					course.remove();
				    				 });
				    				 
				    				 $(".teacherArchive").show();
							    }else{
							    	alert(data.msg);
							    }
				  			}
			  			); 
			  	}
	  	});
	});
}


//学生-课程学习调用
function studyToDeal(){
	var size=20;
	var Mconrightp3=$(".Mconrightp3");
	var classIds=new Array();
	var MRbtons=new Array();
	Mconrightp3.each(function(index,element){
		var course = $(this).parent().parent();
		var classid=course.find("input[name='classId']").val();
		classIds[index] = classid;
		MRbtons[index] = course.find(".MRbton a");
		
		//size 一组发送请求
		var index3=(index+1)%size;
		var index2=Div(index,size)*size;
		if(index3==0 || index==Mconrightp3.size()-1){
			//拼参数classids
			var classidStr="";
			for(var i=0;i<size;i++){
	    		if(index3==0||(index3>0&&i<index3)){
	    			if(i==0){
	    				classidStr=classIds[index2+i];
	    			}else{
	    				classidStr+=','+classIds[index2+i];
	    			}
	    		}
			}
			
			var url ="/mycourse/curLearnStudentCourse?clazzids=" + classidStr+"&index="+index;
			jQuery.ajax({
			    url:url,
			    data:'', 
			    type:'get', 
			    dataType:'json',
			    success:function(data) {
			    	if(data.index!=-1){
			    		var modindex=(data.index+1)%size;
			    		var divindex=Div(data.index,size)*size;
			    		for(var i=0;i<size;i++){
			    			if(modindex==0||(i<modindex)){
			    				if(data[classIds[divindex+i]]){
			    					var chapterId=data[classIds[divindex+i]].chapterId;
			    					var  unfinishCount=data[classIds[divindex+i]].uncount;
			    					var alink=$(MRbtons[divindex+i]).parent().prev().children().eq(0);
			    					if(chapterId &&chapterId!=0){
			    						var myCourseId=data[classIds[divindex+i]].courseId;
			    						var myClassId=data[classIds[divindex+i]].clazzId;
			    						//课程学习
			    						$(MRbtons[divindex+i]).attr("href","/mycourse/studentstudy?chapterId=" + chapterId + "&courseId=" + myCourseId + "&clazzid=" + myClassId);
			    						//任务点
			    						alink.attr("href","/mycourse/studentstudy?chapterId=" + chapterId + "&courseId=" + myCourseId + "&clazzid=" + myClassId);
			    					}
			    					//任务点
			    					if(unfinishCount>0){
		    							alink.show();
		    						}else{
		    							alink.hide();
		    						}
		    						//屏蔽显示信息
		    						alink.hide();
			    					var iclass=unfinishCount>=10? "zta_yellow1":"zta_yellow";
		    						unfinishCount=unfinishCount>99? "99+":unfinishCount>0?unfinishCount:"";
		    						alink.find("i").attr("class",iclass);
		    						alink.find("i").html(unfinishCount);
			    				}
			    			}
			    		}
			    	}
			     }
			});
		}
		
		
	});
}


//异步请求-我教的课
var zmodel=$(".zmodel");
var loading=$("#loading");
var tach=0,study=1;
function getMyTachCourse(){
	loading.show();
	zmodel.html("");
	var url =ServerHost.moocDomain+"/visit/courses/teach?isAjax=true";
	jQuery.ajax({    
	    url:url,
	    data:'',    
	    type:'get', 
	    success:function(data) {
	    	loading.hide();
		    if(/^\s*$/.test(data)){
		    }else{
		    	$(zmodel[tach]).html(data);
		    	fileEffect();
		    	fileDeal();
		    	//屏蔽信息查询
		    	//teachMsgDeal();
		    }
	     },    
	     error : function() {
			$(zmodel[tach]).html("获取我教的异常，请刷新再试！");
	     	loading.hide();
	     }
	});
}


//异步请求-我学的课
function getMyStudyCourse(fileId){
	//alert(fileId);
	var debug = $("#debug").val();
	loading.show();
	zmodel.html("");
	var url ="/visit/courses/study?isAjax=true" ;
	jQuery.ajax({    
	    url:url,
	    data:{fileId:fileId,debug:debug},
	    type:'get', 
	    success:function(data) {
	    	loading.hide();
		    if(/^\s*$/.test(data)){
		    }else{
		    	$(zmodel[study]).html(data);
		    	fileEffect();
		    	quitDeal();
		    	//studyToDeal();
		    	//屏蔽信息查询
		    	//studyMsgDeal();
		    }
	     }, 
	     error : function() {   
	     	$(zmodel[study]).html("获取我的课程异常，请刷新再试！");
	     	loading.hide();
	     }
	});
}


function Div(exp1, exp2){
    var n1 = Math.round(exp1); //四舍五入
    var n2 = Math.round(exp2); //四舍五入
    var rslt = n1 / n2; //除
    if (rslt >= 0){
        rslt = Math.floor(rslt); //返回值为小于等于其数值参数的最大整数值。
    }else{
        rslt = Math.ceil(rslt); //返回值为大于等于其数字参数的最小整数。
    }
    return rslt;
}

/**课程文件夹**/

//移动
$(".zmodel").delegate(".move","click",function(evt){
	
	var iTop = $(top).scrollTop() + $(top).height() / 2 - 320;
	WAY.box.show({"divid":"fileDialog","mask":false,"top":iTop});
	$("#moveClassId").val($(this).parent().parent().find("input[name='classId']").val());
});
//确认移动
$("body").delegate("#fileDialog .btnDiv .confirmMove","click",function(){
	var inputEl =  $("#fileDialog .selected input[name='fileId']");
	if(inputEl.length<1){
		location.reload();
		return ;
	}
	var fileId =$(inputEl).val();
	var classId = $("#moveClassId").val();
	jQuery.ajax({
	    url:"/fileCourse/moveCourse",
	    data:{
	    	fileId:fileId,
	    	classId:classId
	    	}, 
	    type:'get',
	    success:function(data) {
	    	if("success"==data){
	    		location.reload();
	    	}else{
	    		alert("操作失败！");
	    	}
	    },
	    error:function(XMLHttpRequest, textStatus, errorThrown){
	    }});
	    
});
//移动课程对话框在新建文件夹后点击取消新建的文件需要加入到课程列表中
$("body").delegate("#fileDialog .btnDiv .cancleBtn","click",function(){	
	WAY.box.hide();
	location.reload();
});
//创建文件夹
$("body").delegate("#fileDialog .createFile","click",function(){
	var newItem="<li><div class=\"fileImg\"><img src=\"/images/createBySelf.png\"  width=\"78\" height=\"69\"></div><p class=\"fileName\"><input style=\"text-align:center\" type=\"text\" class=\"createFileName\"></input></p><i class=\"delBtn\"></i></li>";
	$(".createFilex").parent().before(newItem);
	$("#fileDialog .createFileName")[0].focus();
});


//删除
$("body").delegate("#fileDialog .delBtn","click",function(){
	var fileId = $(this).parent().find("input").val();
	//$(this).parent().hide();
	$("#delFileId").val(fileId);
	$("#fileDialog .delLayer").css("display","block");
	return false;
	
});
function delFile(){
	 var fileId =$("#delFileId").val();
	 
	 jQuery.post("/fileCourse/del",
	    		{fileId:fileId},
	            function(data){
	    			if(data=="failed"){
	    				alert("操作失败！");
	    			}else{
	    				$("#"+fileId).removeClass('selected');
	    				$("#"+fileId).hide();
	    				$("."+fileId).hide();
	    				$(".delLayer").hide();
	    				location.reload();
	    			}
	  			}
			); 
}
function outDelFile(){
	 var fileId =$("#outDelFileID").val();
	 
	 jQuery.post("/fileCourse/del",
	    		{fileId:fileId},
	            function(data){
	    			if(data=="failed"){
	    				alert("操作失败！");
	    			}else{
	    				$("."+fileId).hide();
	    				$("#"+fileId).hide();
	    				WAY.box.hide();
	    				location.reload();
	    			}
	  			}
			); 
}
$("body").delegate(".Mcon1img .del","click",function(){
	var fileId = $(this).parent().find("input").val();
	$("#outDelFileID").val(fileId);
	var h = $(this).offset().top+50;
    $("#outdelLayer").css("display","block");
	WAY.box.show({"divid":"outdelLayer","mask":false,"top":h});
})

$("body").delegate("#fileDialog .nameCancel","click",function(){
	$(".collectionList ul ").children().last().remove();
});


$("body").delegate("#fileDialog .nameBtn","click",function(){
    var fileName = $(".nameInp").val();
    if(fileName == "") {
    	fileName = "未命名";
    }
	var pt = $(this).parent();
	pt.html(fileName);
	$(pt).parent().addClass("dir");
    jQuery.post("/fileCourse/create",
    		{fileName:fileName},
            function(data){
    			if(Number(data)>0){
    				var inputEle ="<input type=\"hidden\" name=\"fileId\" value=\""+Number(data)+"\"/>";
    				$(pt).parent().append(inputEle);
    				$(pt).parent().attr("id",Number(data));
    				$("#fileDialog li").removeClass("selected");
    			    $("#"+Number(data)).addClass("selected");
    			}
    			 
  			}
		); 
});


$("body").delegate(".collectionList li.dir","click",function(){
	
	$("#fileDialog li").removeClass("selected");
    $(this).addClass("selected");
});

$(".zmodel").delegate(".updateName","focus",function(event){
	event.stopPropagation();
});

$(".zmodel").delegate(".updateName","blur",function(){
	 var fileId =  $(this).parent().prev().find("input").val();
	 var fileName = $(this).val();
	 var h3 = $(this).parent().find("h3")
	 h3.html(fileName);
	 $(this).hide();
	 h3.show();
	 jQuery.post("/fileCourse/reName",
	    		{
		        fileId:fileId,
		        fileName:fileName
		        },
	            function(data){
	    			if(data=="failed"){
	    				alert("操作失败！");
	    			}else{
	    				$("#"+fileId+" .fileName").html(fileName);
	    			}
	  			}
			); 
	
});


$("body").delegate(".updateName","keyup",function(event){
	
	if(event.keyCode == "13"){
		var fileId =  $(this).parent().prev().find("input").val();
		 var fileName = $(this).val();
		 var h3 = $(this).parent().find("h3")
		 h3.html(fileName);
		 $(this).hide();
		 h3.show();
		 jQuery.post("/fileCourse/reName",
		    		{
			        fileId:fileId,
			        fileName:fileName
			        },
		            function(data){
		    			if(data=="failed"){
		    				alert("操作失败！");
		    			}else{
		    				$("#"+fileId+" .fileName").html(fileName);
		    			}
		  			}
				); 
	}
        
	 
});
$(".zmodel").delegate(".rname","click",function(){
	var next = $(this).parent().next();
	$(next).find("h3").hide();
	var inputEle = $(next).find("input");
	$(inputEle).show();
	$(inputEle).focus();
	$(inputEle).val($(inputEle).val())
});
var openFaceTip = function(courseId,classId){
	$("#faceCourseId").val(courseId);
	$("#faceClassId").val(classId);
	var iTop = $(top).scrollTop() + $(top).height() / 2 - 320;
	WAY.box.show({"divid":"js-face","mask":false,"top":iTop});
}

$(document).on('click','.face-confirmBtn',function(){
	var courseId=$("#faceCourseId").val();
	var classId =$("#faceClassId").val();
	WAY.box.hide();
//	var sUrl ='https://'+document.domain+'/visit/goToCourseByFace?courseId='+courseId+'&clazzId='+classId;　
	var sUrl ='https://'+window.location.host+'/visit/goToCourseByFace?courseId='+courseId+'&clazzId='+classId;　
    //本地测试注释https
    //var sUrl ='http://mooc0.chaoxing.com/visit/goToCourseByFace?courseId='+courseId+'&clazzId='+classId;　
    window.open (sUrl, "newwindow", "height=700, width=600, top=100px, left=600px, toolbar=no, menubar=no, scrollbars=no, resizable=no,location=no, status=no")
	//var src ="/visit/toFaceReco?courseId="+courseId+"&clazzid="+classId;
	//$("#faceIframe").attr("src",src);;
	//$("#faceLayer").show();
});

